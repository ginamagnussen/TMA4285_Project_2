---
title: "TMA4285 Time series models"
subtitle: "Exercise 8: Comparison of a state space model and a SARIMA model"
author: "Sivert Selnes, Kristine L. Mathisen, Gina Magnussen"
date: "20th of October 2018"
output: 
  pdf_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
# Libraries
library(astsa)
library(forecast)
library(ggplot2)
library(dlm)
library(KFAS)
library(zoo)
# libraries for state-space: dse, dlm, KFAS, stsm
```

#### Remember:

* Note how uncertainty should be written: 0.056(7) (See sources on web page)

# Structure
## Title
## Abstract 
## Introduction
## Theory
```{r, child='theory.Rmd'}

```

---------------------------------------------------------

## Data analysis


## 1. Exploring the data with plotting of relevant statistics
## 2. Justification of the choice of model
## 3. Model parameter estimation including uncertainty 
<!-- Simulation -->
## 4. Model prediction at the given sample points and for the next year including uncertainty of the best linear predictions
<!-- Forecasting -->
## 5. Diagnostics, and model choice discussion including comparison of the two models


## $SARIMA(p,d,q)\times(P,D,Q)_s$ model

The data set consists of total number of international airline passengers, in thousands, for each month from January 1949 to December 1960(reference to data set), giving a total number of $N=144$ observations. 


```{r}
dataseries <- ts(read.table("dataEx8.txt"), frequency = 12)
plot(dataseries,main = "Airline passengers (1949-1960)", ylab="Passengers (in thousands)")
par(mfrow=c(1,2))
acf(dataseries, lag.max = 50)
pacf(dataseries, lag.max = 50)
boxplot(dataseries~cycle(dataseries), xlab="Date", ylab = "Passengers (in thousands)" ,main ="Monthly international air passengers") # MÃ¥ ikke tas med, men viser litt av strukturen til dataene.
```

From the time series plot, this is obviously a non-stationary series as both trend and seasonality is visible in the visualization. Trend is there because the total number of airline passengers on average increases for each month, and seasonality because of the wave-like behaviour of the series. Non-stationarity is further supported by looking at the autocorrelation function, which shows considerable correlation between observations even up to lag $h$ of size $30$, and again a periodic wave-like pattern.

To investigate the data, we first find a transformation to the time series. A normal transformation is the $\log()$-transformation. This transformation seems to stabilize the multiplicative behaviour of the variance so that the variance is not increasing with time.

```{r}
log_series <- log(dataseries)
diff_series <- diff(log_series)
diff2_series <- diff(diff_series)
diff12_series <- diff(diff_series, lag = 12)
#hist(diff12_series)
plot.ts(cbind(log_series, diff_series, diff2_series, diff12_series), main="Transformed and differenced data")
ggtsdisplay(diff12_series)
```

?? Check if this is correct, especially $d=1 or 2$.
Secondly, the data is differenced to remove trend. The parameter $d$ is related to trend within a season, and since this trend seems to be removed by differencing once, we try $d = 1$. As there after differencing once still seems to be a pattern for a seasonol trend equal to the length of a year, i.e. $s = 12$ in a seasonal ARIMA model, a twelfth-order difference is applied. The parameter $D$ is related to this trend between seasons, i.e. the trend one can se from one January month to the next, the second and so on. We therefore set $D = 1$. Differencing once indicates linear trend, both within and between the seasons, which seems reasonable by looking at the time series plot itself.  

Consider now the ACF and the PACF of the last differenced series.

```{r, include=FALSE}
acf2(diff12_series, max.lag = 50)
```

The obtained series after applying the twelfth-order difference seems to be stationary without any trend or seasonality. (Show stationarity?) We can then estimate the parameters.

For the seasonal component, it looks like the ACF is cutting off at lag equal to one season, where $s = 12$, indicating $Q=1$. The PACF seems to be tailing off after lag equal the length of one season, indicating $P=0$. ?? Is the reasoning correct??

In the non-seasonal component, both the ACF and the PACF seem to be tailing off at lower lags.
FILL IN HERE / EXPLANATION for choosing $p, q$.
$p=0$, $q=1$ are good parameters, I think.

```{r, include=FALSE}
fit <- sarima(log_series, 0,1,1,0,1,1,12)
fit$ttable # Gives parameter estimates and their standard deviation
```
?? Bootstrapping for estimation of uncertainty is preferred, but SE is also given here ??. \\
?? How to do bootstrapping ?? \\
?? Transform back ?? \\



Forecasting SARIMA

```{r, include = FALSE}
plot.new()
forecast_sarima <- sarima.for(log_series, 12,0,1,1,0,1,1,12)
title(main="One year forecast based on SARIMA model", xlab = "Time")
forecast_sarima$se
```


### State-space model

```{r, echo=FALSE}
# ap <- log10(AirPassengers) - 2
state_space <- StructTS(dataseries, type = "BSM") # Basic structural model
state_space_log <- StructTS(log_series, type ="BSM")
# state_space$model$T # F in state equation
forecasts <- forecast(state_space_log, h = 50)
#forecasts$lower 
#forecasts$upper
plot(forecasts) 
```

```{r}
model.build <- function(p) {
  return(
    dlmModPoly(2, dV=p[1], dW=p[2:3]) + 
      dlmModSeas(12, dV=p[4])
  )
}
 
#log.air <- log(air) + rnorm(length(log.air), 0, 0.15)
log.air <- log_series
train <- log.air[1:120]
test <- log.air[121:144]
 
model.mle <- dlmMLE(train, parm=c(1, 1, 1, 1), build=model.build)
model.fit <- model.build(model.mle$par)
## FF is G, GG is F?
n <- 2*12
model.forecast <- dlmForecast(model.fit, nAhead=n)
 
x <- index(log.air)
a <- drop(model.forecast$a%*%t(FF(model.fit)))
df <- rbind(
  data.frame(x=index(log.air), y=as.numeric(log.air), series="original"),
  data.frame(x=x[121:144], y=a, series="forecast")
)

g.dlm <- ggplot(df, aes(x=x, y=y, colour=series)) + geom_line()
g.dlm
```


## Siverts take on State Space Models

Setting up the state space model as in example 9.5.2 in the textbook, we define $A$, $Q$ and $F$ as follows:
```{r}

init = rep(0,times=13*13)
F = matrix(init,ncol = 13)
F[1,1] = 1
F[1,2] = 1
F[2,2] = 1
F[3,-(1:2)]= -1 # all elements on row 3 except col 1:2 set to -1
F[4:13,3:12] = diag(10) # indentity matrix in lower right corner

G = rep(1:0, times=13)


```



-------------------------------------------


## Discussion
## Conclusion
## Appendix
## References

